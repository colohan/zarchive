<!DOCTYPE html>
{% autoescape true %}
<html>
  <head>
    <script src='/_ah/channel/jsapi'></script>
    <link type="image/x-icon" rel="shortcut icon" href="/public/z.ico" />
    <link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
  </head>
  <body>
    <script type='text/javascript'>
      // Allow a form to post without navigating to another page:
      postForm = function(oFormElement) {
        if (!oFormElement.action) { return; }
        var oReq = new XMLHttpRequest();
        if (oFormElement.method.toLowerCase() === "post") {
          oReq.open("post", oFormElement.action);
          oReq.send(new FormData(oFormElement));
        } else {
          console.error("Can only use post with this!");
        }
      }

      onMessage = function(m) {
        // Parse the message received from the server:
        message = JSON.parse(m.data);

        // Then simply append it to our list of messages:
        document.getElementById("messages").innerHTML = 
          document.getElementById("messages").innerHTML +
          "<b>" + message.nickname + " (" + message.email + ") (" +
          message.topic + ") [" + message.date + "]</b><blockquote>" +
          message.content + "</blockquote>";
      }
      
      openChannel = function() {
        console.log("openChannel");
        var channel = new goog.appengine.Channel('{{ token }}');
        var handler = {
          'onopen': function() {},
          'onmessage': onMessage,
          'onerror': function() {},
          'onclose': function() {}
        };
        var socket = channel.open(handler);
        socket.onopen = onOpened;
        socket.onmessage = onMessage;
      }
      
      setTimeout(openChannel, 100);
    </script>

    <div id="messages">
    {% for message in messages %}
    <b>{{ message.author.nickname }} ({{ message.author.email }})
      ({{ message.topic }}) [{{ message.date }}]
    </b>
    <blockquote>{{ message.content }}</blockquote>
    {% endfor %}
    </div>

    <form action="/send" method="post" onsubmit="postForm(this); return false;">
      <input value="{{ topic }}" name="topic">
      <div><textarea name="content" rows="3"cols="60"></textarea></div>
      <div><input type="submit" value="Send"></div>
    </form>

  </body>
</html>
{% endautoescape %}



